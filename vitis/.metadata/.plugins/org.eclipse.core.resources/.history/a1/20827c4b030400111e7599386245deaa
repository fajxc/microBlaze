#include "xparameters.h"
#include "xil_io.h"
#include "xil_printf.h"
#include "sleep.h"

// CHANGE THIS to whatever shows up in xparameters.h
// Search for "_S00_AXI_BASEADDR" and pick your IP.
#define BASE 0x44A00000

#define REG0 (BASE + 0x00)
#define REG1 (BASE + 0x04)
#define REG2 (BASE + 0x08)
#define REG3 (BASE + 0x0C)

static void write_pixel(u32 idx, u8 pix)
{
    Xil_Out32(REG2, idx);   // set pixel index
    Xil_Out32(REG1, pix);   // write pixel value (this triggers pix_we pulse)
}

int main()
{
    xil_printf("\r\n=== NN Stub Test ===\r\n");

    // Make sure start is low (re-armed)
    Xil_Out32(REG0, 0);

    // ---- Test 1: pixel0 = 7 -> predicted should be 7 ----
    write_pixel(0, 7);

    // Start
    Xil_Out32(REG0, 1);

    // Poll done
    while ((Xil_In32(REG3) & 0x1) == 0) {}

    u32 r = Xil_In32(REG3);
    u32 pred = (r >> 4) & 0xF;
    xil_printf("Test1: REG3=0x%08lx pred=%lu (expect 7)\r\n", r, pred);

    // Re-arm (core holds done until start goes low)
    Xil_Out32(REG0, 0);

    usleep(1000);

    // ---- Test 2: pixel0 = 12 -> predicted should be 12 ----
    write_pixel(0, 12);

    Xil_Out32(REG0, 1);
    while ((Xil_In32(REG3) & 0x1) == 0) {}

    r = Xil_In32(REG3);
    pred = (r >> 4) & 0xF;
    xil_printf("Test2: REG3=0x%08lx pred=%lu (expect 12)\r\n", r, pred);

    Xil_Out32(REG0, 0);

    xil_printf("Done.\r\n");

    while (1) {}
}
